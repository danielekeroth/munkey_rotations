version: 1.0
author: munkey
spec: 256
name: Discipline
description: Banging disc priest rotation

morphs:
  smite: void_blast

config:
  ## Emergency Settings
  pain_suppression_usage:
    label: Auto-use PS on
    type: multi_select
    options:
      - label: "Tank"
        value: 1
      - label: "Healer"
        value: 2
      - label: "DPS"
        value: 3
    default: [0,1]
  pain_suppression_threshold:
    label: Pain Suppression %
    default: 20
  ultimate_penitence_members:
    label: "Ult. Pen. Members below HP%"
    min: 1
    max: 5
    default: 3
  ultimate_penitence_hp_treshold:
    label: "Ult. Pen. HP%"
    default: 50
  desperate_prayer_threshold:
    label: Desperate prayer %
    default: 30
  ## Utility Settings
  pwf_fallback_time:
    label: PW:F fallback time
    min: 0
    max: 30
    default: 10
  angelic_feather_usage:
    label: Use Angelic Feather
    type: dropdown
    options:
      - label: "None"
        value: 1
      - label: "Only in combat"
        value: 2
      - label: "Only out of combat"
        value: 3
      - label: "Always"
        value: 4
    default: 3
  angelic_feather_movement_time:
    label: Angelic Feather Movement
    type: slider
    min: 0
    max: 5
    default: 2
  ## Mouseover Settings
  MO_enabled:
    label: Enable Mouseover
    type: checkbox
    default: true
  allow_pull_with_mo:
    label: "Pull with MO"
    type: checkbox
    default: false
  MO_pain_suppression:
    label: Use PS on MO
    type: checkbox
    default: true 
  MO_penance:
    label: Use Penance on MO
    type: checkbox
    default: true
  MO_penance_treshold:
    label: "MO Penance"
    default: 60
  MO_flash_heal:
    label: Use Flash Heal on MO
    type: checkbox
    default: true
  MO_flash_heal_treshold:
    label: "MO Flash Heal"
    default: 40
  MO_purify:
    label: Dispell on MO
    type: checkbox
    default: true
  MO_shadow_word_pain:
    label: SW Pain on MO
    type: checkbox
    default: true
  
  ## Out of Combat Settings
  OOC_penance_treshold:
    label: "OOC Penance %"
    default: 95
  OOC_flash_heal_treshold:
    label: "OOC Flash Heal"
    default: 70
  SWD_usage_treshhold:
    label: "SW: Death HP Treshold"
    default: 50
  
  ## Trinket Settings
  living_silk_usage:
    label: "Living Silk usage"
    type: dropdown
    options:
      - label: "On Cooldown"
        value: 1
      - label: "X Members below percentage"
        value: 2
      - label: "Do not use"
        value: 3
    default: 1
  living_silk_members_treshold:
    label: "Living Silk Members"
    min: 1
    max: 5
    default: 3
  living_silk_hp_treshold:
    label: "Living Silk %"
    default: 30
  weal_and_woe_min_stacks:
    label: "Min. weal and woe stacks for PW:S"
    type: slider
    min: 0
    max: 10
    default: 10
  atonement_spread_raid:
    label: "Max missing atonement raid"
    max: 30
    default: 10
  atonement_spread_party:
    label: "Max missing atonement party"
    max: 5
    default: 0
  ## Automated M+ Settings
  use_automated_m_plus: 
    label: "Use Automated M+ Logic"
    type: checkbox
    default: false
  ara_kara_avanoxx_features:
    label: "Ara Kara - Avanoxx"
    type: multi_select
    options:
      - label: "Pre-emptive healing"
        value: 1
      - label: "Auto Leap of Faith"
        value: 2
      - label: "Auto Dispel"
        value: 3
    default: [0,1,2]
  ara_kara_anubzekt_features:
    label: "Ara Kara - Anubzekt"
    type: multi_select
    options:
      - label: "Auto Leap of Faith"
        value: 1
    default: [0]
  ara_kara_kikatal_features:
    label: "Ara Kara - Ki'katal"
    type: multi_select
    options:
      - label: "Pre-emptive shielding"
        value: 1
      - label: "Auto Leap of Faith"
        value: 2
      - label: "Auto Pain Suppression"
        value: 3
    default: [0,1,2]

variables:
  ## Use Angelic Feather if moving for treshhold (2) seconds and no feather on me and in combat or out of combat depending on setting
  use_af: 
    ((config.angelic_feather_usage=2&player.combat)
    |(config.angelic_feather_usage=3&!player.combat)
    |(config.angelic_feather_usage=4))&!buff.angelic_feather.up&moving.time>=config.angelic_feather_movement_time
  ## Someone within 40 yards without my Atonement
  missing_atonement: group.count(cycle.buff.atonement.down.mine&cycle.range<=40&cycle.range>0)
  ## Someone within 40 yards without PW:F
  missing_pwf: group.count(cycle.buff.power_word_fortitude.down&cycle.range>0&cycle.range<=40)>0|buff.power_word_fortitude.down
  ## MO is over a friendly player within 40 yards
  friendly_and_valid_mo: mouseover.exists&mouseover.alive&mouseover.friendly&mouseover.range>0&mouseover.range<=40
  ## Trinket 1 is living silk
  trinket1_living_silk: trinket_1.id=242393
  ## Trinket 2 is living silk
  trinket2_living_silk: trinket_2.id=242393
  ## Living Silk equipped
  trinket_living_silk: var.trinket1_living_silk|var.trinket2_living_silk
  ## Surge of light has procced
  surge_of_light_procced: buff.surge_of_light.react
  ## Number of Weal and Woe stacks
  weal_and_woe_stacks: buff.weal_and_woe.stack
  ## Penance Stacks
  penance_stacks: cooldown.penance.charges
  ## Hold penance if close to full regen and Holy Ray talented
  hold_penance: cooldown.penance.full_recharge_time<2&talent.holy_ray
  use_amp: config.use_automated_m_plus
  ## Trigger for Living Silk based on percentage of members below a certain threshold
  living_silk_treshold_trigger: config.living_silk_usage=2&config.living_silk_members_treshold<=group.count(cycle.health.pct<=config.living_silk_hp_treshold)  
  ## Ara Kara - Avanoxx
  avanoxx_damage_incoming: boss_fight&target.picid=213179&(target.casting.alerting_shrill|target.casting.gossamer_onslaught)
  ## Ara Kara - Anubzekt
  anubzekt_eye_of_the_swarm: boss_fight&target.picid=215405&(target.casting.eye_of_the_swarm)
  ## Ara Kara - Ki'katal
  kikatal_erupting_webs_danger: boss_fight&target.picid=231649&target.casting.erupting_webs&target.casting.erupting_webs.remains<0.1
  kikatal_cosmic_singularity_danger: boss_fight&target.picid=231649&target.casting.cosmic_singularity&target.casting.cosmic_singularity.remains<0.2

lists:
  living_silk:
    - trinket_1,if=var.trinket1_living_silk&trinket_1.ready&(config.living_silk_usage=1|var.living_silk_treshold_trigger)
    - trinket_2,if=var.trinket2_living_silk&trinket_2.ready&(config.living_silk_usage=1|var.living_silk_treshold_trigger)
  out_of_combat:
    - flash_heal,cycle=members,if=var.surge_of_light_procced&cycle.health.pct<=config.OOC_flash_heal_treshold&!player.combat
    - penance,cycle=members,if=cycle.health.pct<=config.OOC_penance_treshold&!player.combat
    - flash_heal,cycle=members,if=cycle.health.pct<=config.OOC_flash_heal_treshold&!player.combat
    - power_word_fortitude,ignore_usable=true,if=var.missing_pwf>0&(lastcast.power_word_fortitude<?config.pwf_fallback_time)>config.pwf_fallback_time
  offensive:
    - shadow_word_pain,if=debuff.shadow_word_pain.refreshable
    - penance,if=cooldown.penance.full_recharge_time=0|buff.power_of_the_dark_side.up|!cooldown.mind_blast.ready
    - mind_blast
    - shadow_word_death,if=health.pct>=config.SWD_usage_treshhold|talent.void_blast
    - void_blast,if=talent.void_blast&buff.entropic_rift.up
    - smite
  high_prio:
    - ultimate_penitence,if=group.count(cycle.health.pct<=config.ultimate_penitence_hp_treshold)>=config.ultimate_penitence_members
    - desperate_prayer,if=health.pct<=config.desperate_prayer_threshold
    - penance,cycle=members,if=health.pct<=config.MO_penance_treshold&!var.hold_penance
  mouseover_friendly:
    - pain_suppression.mouseover,if=player.combat&config.MO_pain_suppression&mouseover.health.pct<=config.pain_suppression_threshold&mouseover.buff.remains(pain_suppression)=0
    - penance.mouseover,if=config.MO_penance&mouseover.health.pct<=config.MO_penance_treshold
    - flash_heal.mouseover,if=config.MO_flash_heal&mouseover.range&mouseover.health.pct<=config.MO_flash_heal_treshold
  mouseover_enemy:
    - shadow_word_pain.mouseover,if=config.MO_enabled&config.MO_shadow_word_pain&mouseover.enemy&mouseover.alive&mouseover.exists&(config.allow_pull_with_mo|mouseover.combat)&mouseover.debuff.remains(shadow_word_pain)=0
  trinkets:
    - call_action_list,name=living_silk,if=var.trinket_living_silk
  moving:
    - penance,cycle=members,if=cycle.health.pct<70&!var.hold_penance # Hold penance if less than 2 seconds to two charges for increased Holy Ray healing
    - power_word_shield,cycle=members,if=cycle.buff.power_word_shield.down&cycle.buff.atonement.down&(var.weal_and_woe_stacks>=config.weal_and_woe_min_stacks|talent.void_blast)
    - power_word_shield,cycle=members,if=cycle.buff.power_word_shield.down&(var.weal_and_woe_stacks>=config.weal_and_woe_min_stacks|talent.void_blast)
    - power_word_shield,target=lowest,if=var.weal_and_woe_stacks>=config.weal_and_woe_min_stacks|talent.void_blast
    - flash_heal,cycle=members,if=cycle.buff.atonement.down&var.surge_of_light_procced
    - flash_heal,cycle=members,if=var.surge_of_light_procced
  pain_suppression_logic:
    - pain_suppression,name="PS Tanks",cycle=tanks,if=config.pain_suppression_usage!=0&cycle.health.pct<config.pain_suppression_threshold
    - pain_suppression,name="PS Healers",cycle=healers,if=config.pain_suppression_usage>=2&cycle.health.pct<config.pain_suppression_threshold
    - pain_suppression,name="PS DPS",cycle=members,if=config.pain_suppression_usage=3&cycle.health.pct<config.pain_suppression_threshold
  atonement_spread:
    - evangelism.player,name="Evangelism (Spread Atonement)",if=var.missing_atonement>1
    - power_word_radiance.player,name="PW Radiance (Spread Atonement)",if=var.missing_atonement>10,delay=100
    - penance,name="Penance (Spread Atonement)",cycle=members,if=cycle.range>0&cycle.range<=40&cycle.buff.atonement.down
    - power_word_shield,name="PW Shield (Weak and Woe, not shielded)",cycle=members,if=cycle.range>0&cycle.range<=40&!cycle.buff.power_word_shield.up&!cycle.buff.atonement.up&(var.weal_and_woe_stacks=config.weal_and_woe_min_stacks|talent.void_blast)
    - power_word_shield,name="PW Shield (Weal and Woe, alredy shielded)",cycle=members,if=cycle.range>0&cycle.range<=40&!cycle.buff.power_word_shield.up&(var.weal_and_woe_stacks=config.weal_and_woe_min_stacks|talent.void_blast)
    - power_word_shield,name="PW Shield (Spread Atonement)",target=lowest,if=cycle.range>0&cycle.range<=40&var.weal_and_woe_stacks=config.weal_and_woe_min_stacks|talent.void_blast
    - flash_heal,name="Flash Heal (Spread Atonement)",cycle=members,if=cycle.range>0&cycle.range<=40&!cycle.buff.atonement.up&var.surge_of_light_procced
    - plea,name="Plea (Spread Atonement)",cycle=members,if=cycle.range>0&cycle.range<=40&!cycle.buff.atonement.up
  core:
    # Necessary actions
    - call_action_list,name=sanity_checks
    - call_action_list,name=spell_queue
    - call_action_list,name=auto_heal
    - call_action_list,name=auto_target_ranged
    # Combat overrides.
    - return,if=!player.combat&!((config.auto_combat.has(1)&target.quest_mob&target.enemy)|(config.auto_combat.has(2)&target.combat&target.enemy)|(config.auto_combat.has(3)&player.auto_attacking&target.enemy))                                                                                                 
    - return,if=!player.combat&config.auto_combat.has(0)   
    # AoE Interrupt
    - psychic_scream,if=interrupts.8y.count>=2|interrupts.8y.stun.count>=2
    # Target Check
    - return,if=!target.valid&!((config.auto_combat.has(1)&target.quest_mob&target.enemy&!target.dead)|(config.auto_combat.has(2)&target.combat&target.enemy&!target.dead)|(config.auto_combat.has(3)&player.auto_attacking&target.enemy&!target.dead))
    - return,if=!target.valid&config.auto_combat.has(0)   
  dispels:
    - dispel_magic,if=player.dispelable
    - dispel_magic,cycle=members,if=cycle.dispelable
    - purify,if=player.dispelable
    - purify,cycle=members,if=cycle.dispelable
  mythic_plus:
    - call_action_list,name=ara_kara
  ara_kara:
    ## Trash
    - dispel_magic,cycle=tanks,if=cycle.debuff.tainted_blood.stack>=12|mouseover.exists&mouseover.friendly&mouseover.debuff.tainted_blood.stack>=8
    ## Avanoxx
    - ultimate_penitence,name="Pre-emptive penitence",if=var.use_amp&config.ara_kara_avanoxx_features.has(1)&var.avanoxx_damage_incoming&group.count(cycle.health.pct<=50)>=3
    - power_word_shield,cycle=members,if=var.use_amp&config.ara_kara_avanoxx_features.has(1)&var.avanoxx_damage_incoming&cycle.health.pct<=50&cycle.buff.power_word_shield.down
    - penance,cycle=members,if=var.use_amp&config.ara_kara_avanoxx_features.has(1)&var.avanoxx_damage_incoming&cycle.health.pct<=50&cycle.buff.power_word_shield.down
    - leap_of_faith,cycle=dps,if=var.use_amp&config.ara_kara_avanoxx_features.has(2)&cycle.debuff.vile_webbing.stack>3
    - dispel_magic,cycle=members,if=var.use_amp&config.ara_kara_avanoxx_features.has(3)&cycle.debuff.web_wrap.up
    ## Anubzekt
    - leap_of_faith,cycle=dps,if=var.use_amp&config.ara_kara_anubzekt_features.has(1)&target.casting.eye_of_the_swarm&cycle.debuff.ceaseless_swarm.stack>2
    - leap_of_faith,cycle=members,if=var.use_amp&config.ara_kara_anubzekt_features.has(1)&cycle.debuff.silken_restraints.up
    - power_word_shield,cycle=dps,if=target.casting.eye_of_the_swarm&cycle.debuff.ceaseless_swarm.stack>2 
    - penance,cycle=dps,if=target.casting.eye_of_the_swarm&cycle.debuff.ceaseless_swarm.stack>2 
    ## Ki'katal
    - leap_of_faith,cycle=members,if=var.use_amp&config.ara_kara_kikatal_features.has(2)&((var.kikatal_erupting_webs_danger&cycle.debuff.grasping_blood.down)|(var.kikatal_cosmic_singularity_danger&cycle.debuff.grasping_blood.down&cycle.buff.deaths_advance.down&cycle.buff.))
    - pain_suppression,cycle=members,if=var.use_amp&config.ara_kara_kikatal_features.has(3)&var.kikatal_erupting_webs_danger&cycle.debuff.grasping_blood.up
    - power_word_shield,cycle=members,if=var.use_amp&config.ara_kara_kikatal_features.has(1)&var.kikatal_erupting_webs_danger&cycle.debuff.grasping_blood.up
  main:
    - return,if=player.dead|!state.rotation
    - call_action_list,name=out_of_combat
    - angelic_feather.player,if=var.use_af
    - call_action_list,name=mouseover_friendly,if=config.MO_enabled&mouseover.exists&mouseover.alive&!player.casting&!player.channeling&mouseover.friendly
    - call_action_list,name=mouseover_enemy,if=config.MO_enabled&mouseover.exists&mouseover.alive&!player.casting&!player.channeling&mouseover.enemy
    - call_action_list,name=core
    - call_action_list,name=mythic_plus,if=player.in_mythic_plus
    - call_action_list,name=pain_suppression_logic
    - call_action_list,name=moving,if=player.moving
    - call_action_list,name=high_prio
    - call_action_list,name=trinkets
    - call_action_list,name=atonement_spread,if=(player.in_raid&var.missing_atonement>config.atonement_spread_raid)|var.missing_atonement>config.atonement_spread_party
    - call_action_list,name=offensive,if=target.valid