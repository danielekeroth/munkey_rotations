version: 1
author: munkey
class: druid
spec: feral
name: Feral M+
description: This is a basic rotation for feral in M+ content
entry: main

morphs:
  ferocious_bite: ravage
  feral_frenzy: frantic_frenzy

config:
  energy_dump_threshold:
    label: "Energy Dump Threshold %"
    type: slider
    min: 70
    max: 95
    default: 80
    description: "Dump energy when above this % and Tiger's Fury coming off CD"
  tiger_fury_prep_time:
    label: "Tiger's Fury Prep Time (s)"
    type: slider
    min: 1.0
    max: 5.0
    default: 3.0
    description: "Start energy dumping when Tiger's Fury CD is below this"
  pandemic_threshold:
    label: "Pandemic Refresh Threshold"
    type: slider
    min: 0.2
    max: 0.4
    default: 0.3
    description: "Refresh DoTs when below this % of duration remaining"
  rake_pandemic_threshold:
    label: "Rake Pandemic Threshold"
    type: slider
    min: 0.2
    max: 0.4
    default: 0.3
    description: "Refresh Rake when below this % of duration remaining"
  rip_pandemic_threshold:
    label: "Rip Pandemic Threshold"
    type: slider
    min: 0.2
    max: 0.4
    default: 0.3
    description: "Refresh Rip when below this % of duration remaining"
  aoe_enemy_threshold:
    label: "AoE Enemy Threshold"
    type: slider
    min: 2
    max: 5
    default: 3
    description: "Switch to AoE rotation when this many enemies present"
  target_switching_enabled:
    label: "Enable Target Switching"
    type: checkbox
    default: true
    description: "Allow automatic target switching for optimal DPS"
  sync_major_cooldowns:
    label: "Sync Major Cooldowns"
    type: checkbox
    default: true
    description: "Synchronize Berserk, Tiger's Fury, and Convoke usage"
  hold_cooldowns_for_sync:
    label: "Hold CDs for Sync"
    type: checkbox
    default: true
    description: "Hold cooldowns to synchronize with other major CDs"
  convoke_sync_window:
    label: "Convoke Sync Window (s)"
    type: slider
    min: 5
    max: 15
    default: 10
    description: "Hold Convoke if other CDs ready within this window"
  use_stealth_opener:
    label: "Use Stealth Opener"
    type: checkbox
    default: true
    description: "Execute optimized opener sequence from stealth"
  opener_sequence_strict:
    label: "Strict Opener Sequence"
    type: checkbox
    default: false
    description: "Follow exact opener sequence or allow flexibility"
  berserk_combo_alternation:
    label: "Berserk Combo Alternation"
    type: checkbox
    default: true
    description: "Alternate between finishers and builders during Berserk"
  berserk_overflow_management:
    label: "Berserk Overflow Management"
    type: checkbox
    default: true
    description: "Manage combo point overflow during Berserk windows"
  apex_predator_priority:
    label: "Apex Predator Priority"
    type: checkbox
    default: true
    description: "Prioritize Ferocious Bite when Apex Predator's Craving procs"
  sudden_ambush_priority:
    label: "Sudden Ambush Priority"
    type: checkbox
    default: true
    description: "Prioritize Shred when Sudden Ambush procs with active Rake"
  ravage_proc_priority:
    label: "Ravage Proc Priority"
    type: checkbox
    default: true
    description: "Prioritize Ravage procs for Druid of the Claw"
  auto_interrupts:
    label: "Auto Interrupts"
    type: checkbox
    default: true
    description: "Automatically interrupt important enemy casts"
  interrupt_delay:
    label: "Interrupt Delay (ms)"
    type: slider
    min: 100
    max: 500
    default: 200
    description: "Delay before interrupting to avoid wasting interrupts"
  only_important_interrupts:
    label: "Only Important Interrupts"
    type: checkbox
    default: true
    description: "Only interrupt spells marked as important"
  min_fight_duration:
    label: "Min Fight Duration (s)"
    type: slider
    min: 10
    max: 60
    default: 20
    description: "Don't use major cooldowns if fight ends soon"
  target_switching_range:
    label: "Target Switch Range (yards)"
    type: slider
    min: 5
    max: 15
    default: 8
    description: "Maximum range for target switching"
  energy_cap_threshold:
    label: "Energy Cap Threshold %"
    type: slider
    min: 85
    max: 100
    default: 95
    description: "Emergency dump energy when above this % to prevent waste"
  combo_point_waste_threshold:
    label: "Combo Point Waste Threshold"
    type: slider
    min: 3
    max: 5
    default: 4
    description: "Consider combo point waste when at or above this value"
  opener_rake_delay:
    label: "Opener Rake Delay (ms)"
    type: slider
    min: 0
    max: 500
    default: 100
    description: "Delay before casting Rake in opener sequence"
  opener_flexibility_window:
    label: "Opener Flexibility Window (s)"
    type: slider
    min: 3
    max: 10
    default: 5
    description: "Time window for flexible opener execution"
  dot_spread_priority:
    label: "DoT Spread Priority"
    type: checkbox
    default: true
    description: "Prioritize spreading DoTs to multiple targets in AoE"
  maintain_dots_on_switch:
    label: "Maintain DoTs on Switch"
    type: checkbox
    default: true
    description: "Keep DoTs active when switching between targets"
  priority_target_focus:
    label: "Priority Target Focus"
    type: checkbox
    default: true
    description: "Focus on elite/rare/boss targets when available"

variables:
  energy_dump_needed: energy.pct>config.energy_dump_threshold&cooldown.tigers_fury.remains<config.tiger_fury_prep_time
  energy_available_rake: energy>=35
  energy_available_rip: energy>=30
  energy_available_shred: energy>=40
  energy_available_swipe: energy>=45
  energy_available_ferocious_bite: energy>=25
  energy_available_primal_wrath: energy>=20
  energy_waste_potential: energy>90&!var.energy_dump_needed
  energy_starved: energy<30
  energy_cap_reached: energy.pct>=config.energy_cap_threshold
  combo_points_capped: combo_points>=5
  combo_points_for_finisher: combo_points>=5
  combo_points_low: combo_points<=2
  combo_points_empty: combo_points=0
  combo_point_waste_threshold_met: combo_points>=config.combo_point_waste_threshold
  berserk_window_active: buff.berserk.up|buff.incarnation_avatar_of_ashamane.up
  overflow_combo_points: var.berserk_window_active&combo_points>5
  berserk_combo_buffer: var.berserk_window_active&combo_points<5
  combo_point_waste_potential: combo_points>=var.combo_point_waste_threshold_met&!var.combo_points_for_finisher
  combo_generation_needed: combo_points<3&!buff.apex_predators_craving.up
  resource_efficiency_good: "!var.energy_waste_potential&!var.combo_point_waste_potential"
  resource_dump_priority: var.energy_dump_needed|var.combo_points_capped|var.energy_cap_reached
  resource_generation_priority: var.energy_starved|var.combo_generation_needed
  enemies_in_range: enemies.8y
  enemies_in_melee: enemies.8y
  enemies_total: active_enemies
  aoe_situation: var.enemies_in_range>=config.aoe_enemy_threshold
  single_target_situation: var.enemies_in_range<config.aoe_enemy_threshold
  cleave_situation: var.enemies_in_range>=2&var.enemies_in_range<config.aoe_enemy_threshold
  target_valid: target.exists&target.enemy&target.alive
  target_in_range: target.range<=config.target_switching_range
  target_in_melee: target.range<=5
  target_attackable: var.target_valid&var.target_in_range&!target.immune
  target_switching_available: config.target_switching_enabled&var.enemies_in_range>1
  best_target_available: var.target_switching_available&target.health.pct<100
  priority_target_exists: target.classification.elite|target.classification.rare|target.classification.boss
  rake_targets_missing: active_enemies - active_dot.rake
  rip_targets_missing: active_enemies - active_dot.rip
  dot_spread_needed: var.aoe_situation&(active_dot.rake<active_enemies|active_dot.rip<active_enemies)&config.dot_spread_priority
  dot_maintenance_priority: config.maintain_dots_on_switch&var.target_switching_available
  
  # Range and positioning validation
  enemies_in_swipe_range: enemies.8y
  enemies_in_primal_wrath_range: enemies.8y
  optimal_positioning: var.enemies_in_range=var.enemies_in_swipe_range
  
  # AoE threshold and priority switching
  aoe_threshold_met: var.enemies_in_range>=config.aoe_enemy_threshold
  aoe_priority_active: var.aoe_threshold_met&var.optimal_positioning
  single_target_priority_active: "!var.aoe_threshold_met&var.target_attackable"
  
  # Target health and priority assessment
  target_low_health: target.health.pct<=35
  target_dying_soon: target.time_to_die<=10
  execute_range: var.target_low_health&var.target_dying_soon
  
  # Multi-target priority assessment
  high_priority_targets: 0
  focus_high_priority: var.high_priority_targets>0&config.target_switching_enabled&config.priority_target_focus
  
  # === DOT TRACKING VARIABLES ===
  # Rake DoT tracking
  rake_missing: "debuff.rake.down"
  rake_pandemic: debuff.rake.refreshable
  rake_refresh_needed: var.rake_missing|var.rake_pandemic
  rake_duration_remaining: debuff.rake.remains
  
  # Rip DoT tracking  
  rip_missing: "debuff.rip.down"
  rip_pandemic: debuff.rip.refreshable
  rip_refresh_needed: var.rip_missing|var.rip_pandemic
  rip_duration_remaining: debuff.rip.remains
  
  # DoT management priorities
  dots_missing: var.rake_missing|var.rip_missing
  dots_pandemic: var.rake_pandemic|var.rip_pandemic
  dots_active: debuff.rake.up&debuff.rip.up
  
  # === PROC TRACKING VARIABLES ===
  apex_predators_craving_up: buff.apex_predators_craving.up
  apex_predators_craving_remains: buff.apex_predators_craving.remains
  apex_predators_craving_priority: var.apex_predators_craving_up&config.apex_predator_priority
  
  sudden_ambush_up: buff.sudden_ambush.up
  sudden_ambush_remains: buff.sudden_ambush.remains
  sudden_ambush_with_rake: var.sudden_ambush_up&debuff.rake.up&config.sudden_ambush_priority
  
  ravage_up: buff.ravage.up
  ravage_stacks: buff.ravage.stack
  ravage_remains: buff.ravage.remains
  ravage_priority: var.ravage_up&config.ravage_proc_priority
  
  # === BUFF STACK TRACKING VARIABLES ===
  panthers_guile_stacks: buff.panthers_guile.stack
  panthers_guile_max_stacks: var.panthers_guile_stacks>=3
  panthers_guile_active: buff.panthers_guile.up
  tigers_fury_up: buff.tigers_fury.up
  tigers_fury_remains: buff.tigers_fury.remains
  tigers_fury_ready: cooldown.tigers_fury.ready
  tigers_fury_cd_remains: cooldown.tigers_fury.remains
  berserk_up: buff.berserk.up|buff.incarnation_avatar_of_ashamane.up
  berserk_remains: buff.berserk.remains+buff.incarnation_avatar_of_ashamane.remains
  berserk_ready: cooldown.berserk.ready|cooldown.incarnation_avatar_of_ashamane.ready
  berserk_cd_remains: cooldown.berserk.remains+cooldown.incarnation_avatar_of_ashamane.remains
  convoke_ready: cooldown.convoke_the_spirits.ready
  convoke_cd_remains: cooldown.convoke_the_spirits.remains
  convoke_cast_time: action.convoke_the_spirits.execute_time
  feral_frenzy_ready: cooldown.feral_frenzy.ready|cooldown.frantic_frenzy.ready
  feral_frenzy_cd_remains: cooldown.feral_frenzy.remains|cooldown.frantic_frenzy.remains
  feral_frenzy_charges: cooldown.feral_frenzy.charges|cooldown.frantic_frenzy.remains
  major_cooldowns_ready: var.berserk_ready&var.tigers_fury_ready&config.sync_major_cooldowns
  convoke_sync_ready: var.major_cooldowns_ready&var.convoke_ready
  cooldown_sync_window: var.berserk_cd_remains<config.convoke_sync_window|var.tigers_fury_cd_remains<config.convoke_sync_window
  hold_berserk_for_sync: config.hold_cooldowns_for_sync&var.tigers_fury_cd_remains<config.convoke_sync_window&!var.tigers_fury_ready
  hold_tigers_fury_for_sync: config.hold_cooldowns_for_sync&var.berserk_cd_remains<config.convoke_sync_window&!var.berserk_ready
  hold_convoke_for_sync: config.hold_cooldowns_for_sync&var.cooldown_sync_window&!var.major_cooldowns_ready
  perfect_sync_available: var.berserk_ready&var.tigers_fury_ready&var.convoke_ready&config.sync_major_cooldowns
  partial_sync_available: (var.berserk_ready&var.tigers_fury_ready)|(var.berserk_ready&var.convoke_ready)|(var.tigers_fury_ready&var.convoke_ready)
  sync_window_active: var.berserk_up|var.tigers_fury_up|(var.cooldown_sync_window&config.hold_cooldowns_for_sync)
  energy_dump_for_tigers_fury: var.energy_dump_needed&!var.tigers_fury_ready&var.tigers_fury_cd_remains<config.tiger_fury_prep_time
  energy_dump_for_berserk: energy.pct>70&!var.berserk_ready&var.berserk_cd_remains<5&config.sync_major_cooldowns
  energy_dump_for_sync: var.energy_dump_for_tigers_fury|var.energy_dump_for_berserk
  major_cooldown_window: var.berserk_up|var.tigers_fury_up
  optimal_cooldown_window: var.berserk_up&var.tigers_fury_up
  convoke_window_active: var.major_cooldown_window&var.convoke_ready
  fight_duration_short: fight_remains<=30
  fight_duration_medium: fight_remains>30&fight_remains<=120
  fight_duration_long: fight_remains>120
  cooldown_usage_aggressive: var.fight_duration_short|!config.hold_cooldowns_for_sync
  cooldown_usage_conservative: var.fight_duration_long&config.hold_cooldowns_for_sync
  prowl_up: buff.prowl.up
  prowl_available: cooldown.prowl.ready&var.berserk_up
  stealth_active: buff.prowl.up|buff.shadowmeld.up|buff.stealth.up
  opener_conditions_met: var.stealth_active&config.use_stealth_opener&combat.time<=config.opener_flexibility_window
  opener_timing_flexible: "!config.opener_sequence_strict&var.stealth_active&combat.time<=config.opener_flexibility_window"
  
  # === TALENT-SPECIFIC LOGIC VARIABLES ===
  # Incarnation: Avatar of Ashamane talent detection and replacement logic
  incarnation_talented: talent.incarnation_avatar_of_ashamane.enabled
  incarnation_active: buff.incarnation_avatar_of_ashamane.up
  incarnation_ready: cooldown.incarnation_avatar_of_ashamane.ready
  incarnation_cd_remains: cooldown.incarnation_avatar_of_ashamane.remains
  
  # Berserk replacement logic - use Incarnation when talented, otherwise Berserk
  primary_berserk_spell: var.incarnation_talented
  berserk_spell_active: buff.berserk.up|var.incarnation_active
  berserk_spell_ready: cooldown.berserk.ready|var.incarnation_ready
  berserk_spell_cd_remains: cooldown.berserk.remains+var.incarnation_cd_remains
  
  # Prowl usage during Incarnation windows - enhanced stealth mechanics
  incarnation_prowl_window: var.incarnation_active
  prowl_during_incarnation: var.incarnation_prowl_window&!var.prowl_up&cooldown.prowl.ready
  incarnation_prowl_benefits: var.incarnation_active&var.prowl_up
  
  # Coiled to Spring talent interaction - overflow combo point mechanics
  coiled_to_spring_active: talent.coiled_to_spring.enabled
  coiled_to_spring_overflow: var.coiled_to_spring_active&var.overflow_combo_points
  coiled_to_spring_benefit: var.coiled_to_spring_active&var.berserk_window_active&combo_points>5
  coiled_to_spring_storage: var.coiled_to_spring_active&combo_points>=7
  
  # Druid of the Claw hero talent detection and Ravage proc priority
  druid_of_claw_talented: talent.druid_of_the_claw.enabled
  ravage_proc_active: var.ravage_up&var.druid_of_claw_talented
  ravage_proc_priority_high: var.ravage_proc_active&var.ravage_stacks>=2
  ravage_proc_priority_medium: var.ravage_proc_active&var.ravage_stacks=1
  
  # Ravage proc preservation logic - prevent munching with Ferocious Bite
  ravage_munch_risk: var.ravage_up&var.rip_pandemic&combo_points>=5
  ravage_preservation_needed: var.ravage_munch_risk&var.druid_of_claw_talented
  ferocious_bite_to_preserve_ravage: var.ravage_preservation_needed&var.energy_available_ferocious_bite
  
  # Claw Rampage synergy during Berserk windows - additional Ravage generation
  claw_rampage_window: var.berserk_window_active&var.druid_of_claw_talented
  claw_rampage_ravage_generation: var.claw_rampage_window&var.ravage_stacks<3
  claw_rampage_synergy_active: var.claw_rampage_window&var.berserk_up
  claw_rampage_combo_efficiency: var.claw_rampage_synergy_active&combo_points>=3
  
  # Advanced Druid of the Claw mechanics
  druid_of_claw_berserk_value: var.druid_of_claw_talented&var.berserk_window_active
  ravage_stack_management: var.ravage_stacks>=2&var.druid_of_claw_talented
  optimal_ravage_usage: var.ravage_proc_active&(var.berserk_up|combo_points<=3)
  
  # Talent adaptation priority logic
  talent_priority_ravage: var.druid_of_claw_talented&var.ravage_proc_priority_high
  talent_priority_incarnation: var.incarnation_talented&var.incarnation_ready
  talent_priority_coiled_spring: var.coiled_to_spring_active&var.coiled_to_spring_benefit
  
  # === UTILITY AND DEFENSIVE VARIABLES ===
  # Interrupt and utility spell integration
  interrupt_ready: cooldown.skull_bash.ready|cooldown.mighty_bash.ready
  interrupt_target_casting: target.casting&target.casting.elapsed>0.5
  interrupt_important_cast: target.casting.interruptible&target.casting.important
  interrupt_priority_cast: var.interrupt_important_cast&config.only_important_interrupts
  interrupt_any_cast: target.casting.interruptible&!config.only_important_interrupts
  interrupt_needed: config.auto_interrupts&var.interrupt_ready&(var.interrupt_priority_cast|var.interrupt_any_cast)&var.interrupt_target_casting
  
  # Interrupt timing and delay management
  interrupt_delay_met: target.cast_time>config.interrupt_delay/1000
  interrupt_safe_timing: var.interrupt_delay_met&target.casting.elapsed>0.5
  interrupt_emergency: target.cast_time<=1.0&var.interrupt_important_cast
  interrupt_execute: var.interrupt_needed&(var.interrupt_safe_timing|var.interrupt_emergency)
  
  # Utility spell availability and conditions
  cyclone_available: cooldown.cyclone.ready&!debuff.cyclone.up
  entangling_roots_available: cooldown.entangling_roots.ready&!debuff.entangling_roots.up&!target.moving
  hibernate_available: cooldown.hibernate.ready&!debuff.hibernate.up
  soothe_available: cooldown.soothe.ready&target.has_enrage
  
  # Utility spell usage conditions
  utility_cc_needed: target.casting&!var.interrupt_ready&(var.cyclone_available|var.entangling_roots_available)
  utility_soothe_needed: var.soothe_available&target.has_enrage&target.enemy
  utility_hibernate_needed: var.hibernate_available&target.enemy&!target.classification.boss&target.casting.important
  
  # Defensive ability tracking and conditions
  survival_instincts_ready: cooldown.survival_instincts.ready
  barkskin_ready: cooldown.barkskin.ready
  frenzied_regeneration_ready: cooldown.frenzied_regeneration.ready
  renewal_ready: cooldown.renewal.ready&talent.renewal.enabled
  
  # Health thresholds for defensive usage
  health_critical: player.health.pct<=25
  health_low: player.health.pct<=40
  health_moderate: player.health.pct<=60
  health_emergency: player.health.pct<=15
  
  # Defensive usage conditions
  survival_instincts_needed: var.health_critical&var.survival_instincts_ready
  barkskin_needed: var.health_low&var.barkskin_ready&!buff.survival_instincts.up
  frenzied_regen_needed: var.health_moderate&var.frenzied_regeneration_ready&!buff.frenzied_regeneration.up
  renewal_needed: var.health_low&var.renewal_ready&!buff.frenzied_regeneration.up
  emergency_heal_needed: var.health_emergency&(var.renewal_ready|var.frenzied_regeneration_ready)
  
  # Damage reduction and mitigation tracking
  damage_reduction_active: buff.survival_instincts.up|buff.barkskin.up
  damage_reduction_needed: var.health_low&!var.damage_reduction_active
  healing_over_time_active: buff.frenzied_regeneration.up|buff.renewal.up
  
  # Advanced target switching and multi-target DoT maintenance
  # Enhanced target switching logic beyond basic enemy detection
  target_switch_beneficial: var.target_switching_available&var.rake_targets_missing>0
  target_switch_for_dots: var.target_switching_available&(active_dot.rake<active_enemies|active_dot.rip<active_enemies)
  target_switch_priority: var.focus_high_priority&var.high_priority_targets>0&!target.classification.elite
  
  # Multi-target DoT spread and maintenance
  rake_spread_targets: var.rake_targets_missing
  rip_spread_targets: var.rip_targets_missing
  dot_spread_priority: var.rake_spread_targets>=2|var.rip_spread_targets>=1
  dot_maintenance_needed: var.dot_spread_needed&combo_points>=5
  
  # Target switching for optimal DoT coverage
  switch_for_rake: var.rake_spread_targets>0&var.energy_available_rake&config.target_switching_enabled
  switch_for_rip: var.rip_spread_targets>0&combo_points>=5&var.energy_available_rip&config.target_switching_enabled
  switch_for_primal_wrath: var.rip_spread_targets>=2&combo_points>=5&var.energy_available_primal_wrath&config.target_switching_enabled
  
  # Advanced multi-target priority assessment
  dot_coverage_complete: active_dot.rake>=active_enemies&active_dot.rip>=active_enemies
  dot_coverage_partial: active_dot.rake>=active_enemies-1&active_dot.rip>=active_enemies-1
  dot_coverage_poor: active_dot.rake<active_enemies-1|active_dot.rip<active_enemies-1

  # MO-Target Sanity Checks
  mo_valid_for_rake: mouseover.range<8&mouseover.exists&mouseover.alive&mouseover.enemy&mouseover.debuff.remains(rake)<=gcd.remains
  
  # Target switching efficiency - simplified logic  
  target_switch_needed: config.target_switching_enabled&var.aoe_situation&"!var.dot_coverage_complete"
  maintain_current_target: var.dot_coverage_complete|var.single_target_situation|"!config.target_switching_enabled"

lists:
  main:
    # === ROTATION STATE VALIDATION ===
    # Return if rotation is not active or target is invalid
    - return,if=!state.rotation|player.mounted
    - prowl.player,if=buff.prowl.down&!player.combat
    - mark_of_the_wild.mouseover,if=mouseover.buff.remains(mark_of_the_wild)=0&mouseover.friendly&mouseover.alive&!player.combat
    - return,if=!var.target_valid
    
    # === EMERGENCY AND HIGH-PRIORITY ACTIONS ===
    # Immediate response to critical procs and situations
    
    # === UTILITY AND DEFENSIVE PRIORITY ACTIONS ===
    # Highest priority: Emergency defensive responses
    - call_action_list,name=defensive,if=var.health_emergency|var.survival_instincts_needed
    
    # High priority: Interrupt critical enemy casts
    - call_action_list,name=utility,if=var.interrupt_needed&var.target_attackable
    
    # Apex Predator's Craving - highest priority across all scenarios
    - ferocious_bite,if=var.apex_predators_craving_priority&var.energy_available_ferocious_bite&var.target_attackable
    
    # Emergency energy dump when at cap to prevent waste
    - rip,if=var.energy_cap_reached&combo_points>=5&var.rip_refresh_needed&var.energy_available_rip&var.target_attackable&active_enemies=1
    - primal_wrath,if=var.energy_cap_reached&combo_points>=5&var.aoe_situation&var.rip_refresh_needed&var.energy_available_primal_wrath
    
    # Emergency combo point dump when at overflow risk
    - ferocious_bite,if=combo_points>=5&var.energy_available_ferocious_bite&var.target_attackable&!var.berserk_window_active
    
    # === STEALTH OPENER SEQUENCE ===
    # Execute optimized opener when stealth conditions are met
    - call_action_list,name=opener,if=var.opener_conditions_met&config.use_stealth_opener    
    
    # === TALENT-SPECIFIC HIGH-PRIORITY ACTIONS ===
    # Druid of the Claw Ravage proc management during Berserk windows
    - call_action_list,name=claw_rampage,if=var.claw_rampage_synergy_active&var.druid_of_claw_talented
    
    # Ravage proc preservation - prevent munching with immediate Ferocious Bite
    - ferocious_bite,if=var.ravage_preservation_needed&var.combo_points_for_finisher&var.energy_available_ferocious_bite&var.target_attackable
    
    # High-priority Ravage usage when stacks are high
    - ravage,if=var.talent_priority_ravage&var.energy_available_shred&var.target_attackable
    
    # === COOLDOWN MANAGEMENT SYSTEM ===
    # Manage major cooldowns and synchronization
    - call_action_list,name=cooldowns,if=var.target_attackable&fight_remains>10
    
    # === PRIORITY SYSTEM SELECTION ===
    # Choose appropriate rotation based on enemy count and situation
    
    # Target switching for DoT maintenance when coverage is incomplete
    - call_action_list,name=target_switching,if=var.target_switch_needed&fight_remains>10
    
    # AoE priority when multiple enemies present
    - call_action_list,name=aoe,if=var.aoe_priority_active&var.target_attackable
    
    # Single-target priority for focused damage
    - call_action_list,name=single_target,if=var.single_target_priority_active&var.target_attackable
    
    # Cleave situation handling (2-3 enemies)
    - call_action_list,name=single_target,if=var.cleave_situation&var.target_attackable
    
    # === EMERGENCY RESOURCE MANAGEMENT ===
    # Handle critical resource situations when action lists don't cover them
    
    # Defensive abilities when health is low
    - call_action_list,name=defensive,if=var.damage_reduction_needed|var.emergency_heal_needed
    
    # Utility spells for crowd control and enemy management
    - call_action_list,name=utility,if=var.utility_cc_needed|var.utility_soothe_needed|var.utility_hibernate_needed
    
    # Emergency Tiger's Fury when energy starved
    - tigers_fury,if=var.energy_starved&var.tigers_fury_ready&var.target_attackable
    
    # Emergency DoT application when missing on valid target
    - rake,if=var.rake_missing&var.energy_available_rake&var.target_attackable
    - rip,if=var.rip_missing&combo_points>=5&var.energy_available_rip&var.target_attackable
    
    # === FALLBACK ACTIONS ===
    # Basic actions when no specific conditions are met
    
    # Combo point generation based on situation
    - shred,if=var.single_target_situation&combo_points<5&var.energy_available_shred&var.target_attackable&!var.ravage_proc_active
    - swipe,if=var.aoe_situation&combo_points<5&var.energy_available_swipe&var.target_attackable&!var.ravage_proc_active
    
    # Basic finisher usage
    - ferocious_bite,if=combo_points>=5&var.energy_available_ferocious_bite&var.target_attackable&var.dots_active
    
    # Resource generation when low
    - tigers_fury,if=var.tigers_fury_ready&energy.pct<=50&var.target_attackable
    
    # === FINAL FALLBACK ===
    # Absolute last resort actions
    - shred,if=var.energy_available_shred&var.target_attackable&combo_points<5
  
  # Stealth opener action list - implements the optimized opener sequence
  opener:
    # Stealth detection and opener initiation conditions
    - return,if=!config.use_stealth_opener
    - return,if=!buff.prowl.up&!buff.shadowmeld.up&!buff.stealth.up&time>config.opener_flexibility_window
    
    # Step 1: Rake as first ability from stealth (Requirement 3.1)
    - rake,if=var.rake_missing&var.energy_available_rake&buff.prowl.up
    - rake,if=var.rake_missing&var.energy_available_rake&(buff.shadowmeld.up|buff.stealth.up)
    
    # Step 2: Swipe to generate 5 Combo Points (Requirement 3.2)
    - swipe,if=combo_points<5&var.energy_available_swipe&debuff.rake.up
    
    # Step 3: Incarnation and Tiger's Fury simultaneously at 5 CP - Incarnation builds
    - incarnation_avatar_of_ashamane,if=var.incarnation_talented&combo_points>=5&var.incarnation_ready&var.tigers_fury_ready&debuff.rake.up
    - tigers_fury,if=var.incarnation_talented&combo_points>=5&var.incarnation_active&var.tigers_fury_ready&debuff.rake.up
    
    # Step 3: Berserk and Tiger's Fury simultaneously at 5 CP - Non-Incarnation builds
    - berserk,if=!var.incarnation_talented&combo_points>=5&var.berserk_ready&var.tigers_fury_ready&debuff.rake.up
    - tigers_fury,if=!var.incarnation_talented&combo_points>=5&var.berserk_up&var.tigers_fury_ready&debuff.rake.up
    
    # Step 4: Primal Wrath to apply Rip
    - primal_wrath,if=combo_points>=5&var.berserk_window_active&var.tigers_fury_up&var.energy_available_primal_wrath&var.rip_missing
    
    # Step 5: Convoke the Spirits
    - convoke_the_spirits,if=var.convoke_ready&var.berserk_window_active&var.tigers_fury_up&debuff.rip.up
    
    # Step 6: Ferocious Bite after Convoke
    - ferocious_bite,if=combo_points>=5&var.energy_available_ferocious_bite&var.berserk_window_active&cooldown.convoke_the_spirits.remains>0&debuff.rip.up
    
    # Step 7: Feral Frenzy to complete opener
    - feral_frenzy,if=var.feral_frenzy_ready&var.berserk_window_active&debuff.rip.up&debuff.rake.up
    
    # === TALENT-SPECIFIC OPENER ENHANCEMENTS ===
    # Use Prowl during Incarnation windows for enhanced stealth benefits
    - prowl,if=var.incarnation_active&!var.prowl_up&spell.prowl.ready&buff.incarnation_avatar_of_ashamane.remains>8
    
    # Ravage proc usage during opener for Druid of the Claw
    - ravage,if=var.ravage_proc_active&var.energy_available_shred&var.berserk_window_active&combo_points<=3
    
    # Berserk window behavior - alternation between finishers and builders
    # During Berserk, alternate between Ferocious Bite at 5 CP and Swipe for generation
    - ferocious_bite,if=var.berserk_window_active&combo_points>=5&var.energy_available_ferocious_bite&config.berserk_combo_alternation&!var.ravage_preservation_needed
    - swipe,if=var.berserk_window_active&combo_points<5&var.energy_available_swipe&config.berserk_combo_alternation&!var.ravage_proc_active
    
    # Handle overflow combo points during Berserk
    - ferocious_bite,if=var.overflow_combo_points&var.energy_available_ferocious_bite&config.berserk_overflow_management&!var.ravage_preservation_needed
    - swipe,if=var.berserk_combo_buffer&var.energy_available_swipe&config.berserk_overflow_management&!var.ravage_proc_active
    
    # Coiled to Spring overflow handling during opener
    - ferocious_bite,if=var.coiled_to_spring_storage&var.energy_available_ferocious_bite&var.berserk_window_active
    
  # Single-target priority system - implements optimized ST rotation
  single_target:
    # === APEX PREDATOR'S CRAVING PRIORITY ===
    # Highest priority: Apex Predator's Craving proc - immediate Ferocious Bite
    - ferocious_bite,if=var.apex_predators_craving_priority&var.energy_available_ferocious_bite
    
    # === DRUID OF THE CLAW RAVAGE PROC PRIORITY ===
    # High priority: Ravage procs for Druid of the Claw builds
    - ravage,if=var.talent_priority_ravage&var.energy_available_shred&var.target_attackable
    - ravage,if=var.ravage_proc_priority_high&var.energy_available_shred&var.target_attackable
    - ravage,if=var.optimal_ravage_usage&var.energy_available_shred&var.target_attackable
    
    # === RAVAGE PROC PRESERVATION LOGIC ===
    # Use Ferocious Bite to prevent Ravage proc munching when Rip is in pandemic
    - ferocious_bite,if=var.ferocious_bite_to_preserve_ravage&var.combo_points_for_finisher&var.target_attackable
    - ferocious_bite,if=var.ravage_preservation_needed&combo_points>=5&var.energy_available_ferocious_bite
    
    # === DOT MANAGEMENT LOGIC ===
    # High priority: Rip missing or in pandemic with 5 combo points
    - rip,if=var.rip_refresh_needed&var.combo_points_for_finisher&var.energy_available_rip&!var.ravage_preservation_needed
    
    # High priority: Rake missing or in pandemic
    - rake,if=var.rake_refresh_needed&var.energy_available_rake
    
    # === FINISHER PRIORITY WITH ACTIVE DOTS ===
    # Ferocious Bite at 5 combo points with active DoTs
    - ferocious_bite,if=var.combo_points_for_finisher&var.dots_active&var.energy_available_ferocious_bite&!var.apex_predators_craving_up&!var.ravage_preservation_needed
    
    # === COILED TO SPRING OVERFLOW INTERACTIONS ===
    # Handle overflow combo points with Coiled to Spring talent
    - ferocious_bite,if=var.coiled_to_spring_storage&var.energy_available_ferocious_bite&var.target_attackable
    - ferocious_bite,if=var.coiled_to_spring_benefit&combo_points>=7&var.energy_available_ferocious_bite
    
    # === PROC UTILIZATION LOGIC ===
    # Sudden Ambush proc with active Rake - prioritize Shred
    - shred,if=var.sudden_ambush_with_rake&var.energy_available_shred&!var.ravage_proc_active
    
    # Medium priority Ravage procs when other conditions aren't met
    - ravage,if=var.ravage_proc_priority_medium&var.energy_available_shred&combo_points<=3&var.target_attackable
    
    # === DEFAULT COMBO POINT GENERATION ===
    # Shred as default combo point generator for single-target
    - shred,if=var.combo_generation_needed&var.energy_available_shred&!var.ravage_proc_active
    - shred,if=combo_points<5&var.energy_available_shred&!var.combo_points_capped&!var.ravage_proc_active
    
  # AoE priority system - implements optimized AoE rotation
  aoe:
    # === APEX PREDATOR'S CRAVING PRIORITY ===
    # Highest priority: Apex Predator's Craving proc - immediate Ferocious Bite
    - ferocious_bite,if=var.apex_predators_craving_priority&var.energy_available_ferocious_bite
    
    # === DRUID OF THE CLAW RAVAGE PROC PRIORITY ===
    # High priority: Ravage procs for Druid of the Claw builds in AoE
    - ravage,if=var.talent_priority_ravage&var.energy_available_shred&var.target_attackable&var.aoe_situation
    - ravage,if=var.ravage_proc_priority_high&var.energy_available_shred&var.target_attackable&var.enemies_in_range>=2
    - ravage,if=var.optimal_ravage_usage&var.energy_available_shred&var.target_attackable&var.aoe_priority_active
    
    # === RAVAGE PROC PRESERVATION LOGIC ===
    # Use Ferocious Bite to prevent Ravage proc munching when Rip is in pandemic
    - ferocious_bite,if=var.ferocious_bite_to_preserve_ravage&var.combo_points_for_finisher&var.target_attackable
    - ferocious_bite,if=var.ravage_preservation_needed&combo_points>=5&var.energy_available_ferocious_bite&var.aoe_situation
    
    # === AOE RIP APPLICATION LOGIC ===
    # High priority: Primal Wrath for AoE Rip application when missing or in pandemic
    - primal_wrath,if=var.rip_refresh_needed&var.combo_points_for_finisher&var.energy_available_primal_wrath&!var.ravage_preservation_needed
    - primal_wrath,if=var.rip_missing&var.combo_points_for_finisher&var.energy_available_primal_wrath&var.aoe_situation&!var.ravage_preservation_needed
    
    # Apply Primal Wrath when multiple targets need Rip
    - primal_wrath,if=active_dot.rip<active_enemies-1&var.combo_points_for_finisher&var.energy_available_primal_wrath&"!var.ravage_preservation_needed"
    
    # === AOE FINISHER PRIORITIES (Requirement 5.4) ===
    # Ferocious Bite at 5 combo points with active Rip on primary target
    - ferocious_bite,if=var.combo_points_for_finisher&debuff.rip.up&var.energy_available_ferocious_bite&!var.apex_predators_craving_up&!var.ravage_preservation_needed
    
    # Ferocious Bite when Rip is active and we have sufficient combo points
    - ferocious_bite,if=var.combo_points_capped&var.dots_active&var.energy_available_ferocious_bite&var.aoe_situation&!var.ravage_preservation_needed
    
    # === COILED TO SPRING OVERFLOW INTERACTIONS ===
    # Handle overflow combo points with Coiled to Spring talent in AoE
    - ferocious_bite,if=var.coiled_to_spring_storage&var.energy_available_ferocious_bite&var.aoe_situation
    - primal_wrath,if=var.coiled_to_spring_benefit&combo_points>=7&var.energy_available_primal_wrath&var.rip_targets_missing>=1
    
    # === RAKE APPLICATION FOR AOE ===
    # Apply Rake to primary target when missing or in pandemic
    - rake,if=var.rake_refresh_needed&var.energy_available_rake&var.target_attackable
    
    # Medium priority Ravage procs in AoE scenarios
    - ravage,if=var.ravage_proc_priority_medium&var.energy_available_shred&combo_points<=3&var.target_attackable&var.aoe_situation
    
    # === SWIPE AS PRIMARY COMBO POINT GENERATOR ===
    # Swipe as primary combo point generator for AoE scenarios
    - swipe,if=var.combo_generation_needed&var.energy_available_swipe&var.aoe_situation&!var.ravage_proc_active
    - swipe,if=combo_points<5&var.energy_available_swipe&var.enemies_in_swipe_range>=config.aoe_enemy_threshold&!var.ravage_proc_active
    - swipe,if=var.combo_points_low&var.energy_available_swipe&var.aoe_priority_active&!var.ravage_proc_active
    
    # Swipe when we need combo points and have multiple enemies
    - swipe,if=combo_points<4&var.energy_available_swipe&var.enemies_in_range>=2&!var.ravage_proc_active
    
    # === FALLBACK COMBO POINT GENERATION ===
    # Use Swipe as default builder in AoE even at lower enemy counts for consistency
    - swipe,if=combo_points<5&var.energy_available_swipe&var.cleave_situation&!var.ravage_proc_active
    
    # Emergency Shred if Swipe unavailable but still need combo points
    - shred,if=combo_points<3&!spell.swipe.ready&var.energy_available_shred&var.target_attackable&!var.ravage_proc_active
    
  # Cooldown management and synchronization system
  cooldowns:
    # === TALENT-SPECIFIC COOLDOWN LOGIC ===
    # Incarnation: Avatar of Ashamane replaces Berserk when talented
    - incarnation_avatar_of_ashamane,if=var.incarnation_talented&var.convoke_sync_ready&var.energy_available_rake&var.target_attackable&fight_remains>30
    - tigers_fury,if=var.incarnation_active&var.convoke_ready&var.energy_available_rake&var.target_attackable
    - convoke_the_spirits,if=var.incarnation_active&var.tigers_fury_up&var.target_attackable&combo_points>=3
    
    # Prowl usage during Incarnation windows for enhanced stealth benefits
    - prowl,if=var.prowl_during_incarnation&var.target_attackable&var.incarnation_active
    - prowl,if=var.incarnation_active&!var.prowl_up&spell.prowl.ready&buff.incarnation_avatar_of_ashamane.remains>5
    
    # === MAJOR COOLDOWN SYNCHRONIZATION ===
    # Synchronize Berserk + Tiger's Fury + Convoke when all available (non-Incarnation builds)
    - berserk,if=!var.incarnation_talented&var.convoke_sync_ready&var.energy_available_rake&var.target_attackable&fight_remains>30
    - tigers_fury,if=buff.berserk.up&var.convoke_ready&var.energy_available_rake&var.target_attackable&!var.incarnation_talented
    - convoke_the_spirits,if=var.berserk_up&var.tigers_fury_up&var.target_attackable&combo_points>=3&!var.incarnation_talented
    
    # === ENERGY DUMP TIMING FOR TIGER'S FURY PREPARATION ===
    # Dump energy before Tiger's Fury when it's coming off cooldown soon
    - ferocious_bite,if=var.energy_dump_needed&var.combo_points_for_finisher&var.energy_available_ferocious_bite&!var.tigers_fury_ready
    - rip,if=var.energy_dump_needed&var.combo_points_for_finisher&var.rip_refresh_needed&var.energy_available_rip&!var.tigers_fury_ready
    - rake,if=var.energy_dump_needed&var.rake_refresh_needed&var.energy_available_rake&!var.tigers_fury_ready
    - shred,if=var.energy_dump_needed&combo_points<5&var.energy_available_shred&!var.tigers_fury_ready&var.single_target_situation
    - swipe,if=var.energy_dump_needed&combo_points<5&var.energy_available_swipe&!var.tigers_fury_ready&var.aoe_situation
    
    # === INDEPENDENT COOLDOWN USAGE ===
    # Feral Frenzy on cooldown - independent of other cooldowns
    - feral_frenzy,if=var.feral_frenzy_ready&var.target_attackable&combo_points>=2&fight_remains>10
    - feral_frenzy,if=var.feral_frenzy_ready&var.target_attackable&var.berserk_window_active&combo_points>=1
    
    # Tiger's Fury on cooldown when not holding for sync
    - tigers_fury,if=var.tigers_fury_ready&!var.hold_tigers_fury_for_sync&var.target_attackable&energy.pct<=60
    - tigers_fury,if=var.tigers_fury_ready&!config.sync_major_cooldowns&var.target_attackable&energy.pct<=60
    
    # Berserk/Incarnation on cooldown when not holding for sync
    - incarnation_avatar_of_ashamane,if=var.incarnation_talented&var.incarnation_ready&!var.hold_berserk_for_sync&var.target_attackable&combo_points>=3&fight_remains>20
    - incarnation_avatar_of_ashamane,if=var.incarnation_talented&var.incarnation_ready&!config.sync_major_cooldowns&var.target_attackable&combo_points>=3&fight_remains>20
    - berserk,if=!var.incarnation_talented&var.berserk_ready&!var.hold_berserk_for_sync&var.target_attackable&combo_points>=3&fight_remains>20
    - berserk,if=!var.incarnation_talented&var.berserk_ready&!config.sync_major_cooldowns&var.target_attackable&combo_points>=3&fight_remains>20
    
    # === CONVOKE OPTIMIZATION WITHIN COOLDOWN WINDOWS ===
    # Use Convoke when not holding for sync but other conditions are met
    - convoke_the_spirits,if=var.convoke_ready&!var.hold_convoke_for_sync&var.target_attackable&combo_points>=2&fight_remains>8
    - convoke_the_spirits,if=var.convoke_ready&!config.sync_major_cooldowns&var.target_attackable&combo_points>=2&fight_remains>8
    
    # Convoke during active cooldown windows for optimization
    - convoke_the_spirits,if=var.convoke_ready&var.berserk_window_active&var.target_attackable&combo_points>=1
    - convoke_the_spirits,if=var.convoke_ready&var.tigers_fury_up&var.target_attackable&combo_points>=2&!var.berserk_spell_ready
    
    # Emergency Convoke usage when fight is ending soon
    - convoke_the_spirits,if=var.convoke_ready&var.target_attackable&fight_remains<=15&combo_points>=1
    
    # === COOLDOWN WINDOW OPTIMIZATION ===
    # Optimize ability usage during major cooldown windows
    - ferocious_bite,if=var.berserk_window_active&var.tigers_fury_up&combo_points>=5&var.energy_available_ferocious_bite&debuff.rip.up
    - rip,if=var.berserk_window_active&var.tigers_fury_up&combo_points>=5&var.rip_refresh_needed&var.energy_available_rip
    - primal_wrath,if=var.berserk_window_active&var.tigers_fury_up&combo_points>=5&var.rip_refresh_needed&var.aoe_situation&var.energy_available_primal_wrath
    
    # Generate combo points efficiently during cooldown windows
    - shred,if=var.berserk_window_active&combo_points<5&var.energy_available_shred&var.single_target_situation
    - swipe,if=var.berserk_window_active&combo_points<5&var.energy_available_swipe&var.aoe_situation
  
  # Claw Rampage synergy management for Druid of the Claw during Berserk windows
  claw_rampage:
    # === CLAW RAMPAGE SYNERGY DURING BERSERK WINDOWS ===
    # Only execute this list when Druid of the Claw is talented and Berserk window is active
    - return,if=!var.druid_of_claw_talented|!var.berserk_window_active
    
    # High priority: Use existing Ravage procs during Claw Rampage windows
    - ravage,if=var.ravage_proc_priority_high&var.energy_available_shred&var.claw_rampage_synergy_active
    - ravage,if=var.ravage_stacks>=2&var.energy_available_shred&var.claw_rampage_window
    
    # Generate additional Ravage procs through ability usage during Berserk
    - ferocious_bite,if=var.claw_rampage_combo_efficiency&combo_points>=5&var.energy_available_ferocious_bite&var.ravage_stacks<3
    - rip,if=var.claw_rampage_combo_efficiency&combo_points>=5&var.rip_refresh_needed&var.energy_available_rip&var.ravage_stacks<3
    - primal_wrath,if=var.claw_rampage_combo_efficiency&combo_points>=5&var.aoe_situation&var.rip_refresh_needed&var.energy_available_primal_wrath&var.ravage_stacks<3
    
    # Combo point generation to fuel Claw Rampage synergy
    - shred,if=var.claw_rampage_ravage_generation&combo_points<5&var.energy_available_shred&var.single_target_situation
    - swipe,if=var.claw_rampage_ravage_generation&combo_points<5&var.energy_available_swipe&var.aoe_situation
    
    # Medium priority Ravage usage when stacks are building
    - ravage,if=var.ravage_proc_priority_medium&var.energy_available_shred&var.claw_rampage_window&combo_points<=3
    
    # Maintain DoTs during Claw Rampage windows for optimal damage
    - rake,if=var.rake_refresh_needed&var.energy_available_rake&var.claw_rampage_window
    
    # Emergency Ravage usage to prevent waste
    - ravage,if=var.ravage_up&var.ravage_remains<=3&var.energy_available_shred&var.claw_rampage_window
  
  # Utility and interrupt management system
  utility:
    # === INTERRUPT PRIORITY (Requirement 9.7) ===
    # Highest priority: Emergency interrupts for critical casts
    - skull_bash,if=var.interrupt_emergency&cooldown.skull_bash.ready&var.target_attackable
    - mighty_bash,if=var.interrupt_emergency&mighty_bash.ready&var.target_attackable&!skull_bash.ready
    
    # Standard interrupt timing with delay consideration
    - skull_bash,if=var.interrupt_execute&skull_bash.ready&var.target_attackable
    - mighty_bash,if=var.interrupt_execute&mighty_bash.ready&var.target_attackable&!skull_bash.ready
    
    # === UTILITY SPELL INTEGRATION (Requirement 9.7) ===
    # Crowd control when interrupts are unavailable
    - cyclone,if=var.utility_cc_needed&var.cyclone_available&var.target_attackable&!var.interrupt_ready
    - entangling_roots,if=var.utility_cc_needed&var.entangling_roots_available&var.target_attackable&!var.interrupt_ready&!var.cyclone_available
    
    # Specialized utility spells
    - soothe,if=var.utility_soothe_needed&var.target_attackable
    - hibernate,if=var.utility_hibernate_needed&var.target_attackable&!target.boss
    
    # === UTILITY SPELL USAGE CONDITIONS ===
    # Remove enrage effects that increase enemy damage
    - soothe,if=target.enraged&soothe.ready&var.target_attackable&target.enemy
    
    # Crowd control dangerous non-boss enemies
    - cyclone,if=target.casting&target.cast_time>2&cyclone.ready&var.target_attackable&!target.boss&!var.interrupt_ready
    - entangling_roots,if=target.moving&target.distance>5&entangling_roots.ready&var.target_attackable&!target.boss
    
    # Beast-specific crowd control
    #- hibernate,if=target.classification.beast&target.enemy&hibernate.ready&var.target_attackable&!target.boss&target.health.pct>50
  
  # Defensive ability usage system
  defensive:
    # === EMERGENCY DEFENSIVE RESPONSES (Requirement 9.8) ===
    # Highest priority: Emergency healing when critically low
    - renewal,if=var.health_emergency&var.renewal_ready
    - frenzied_regeneration,if=var.health_emergency&var.frenzied_regeneration_ready&!var.renewal_ready
    
    # Critical health damage reduction
    - survival_instincts,if=var.survival_instincts_needed
    - barkskin,if=var.health_critical&var.barkskin_ready&!buff.survival_instincts.up
    
    # === PROACTIVE DEFENSIVE USAGE ===
    # Damage reduction when health is low
    #- survival_instincts,if=var.health_low&var.survival_instincts_ready&!var.damage_reduction_active&incoming_damage_5s>player.health*0.4
    #- barkskin,if=var.barkskin_needed&incoming_damage_3s>player.health*0.3
    
    # Healing over time when moderately injured
    - frenzied_regeneration,if=var.frenzied_regen_needed&!var.healing_over_time_active
    - renewal,if=var.renewal_needed&!var.healing_over_time_active&!buff.frenzied_regeneration.up
    
    # === DEFENSIVE ABILITY COMBINATIONS ===
    # Stack damage reduction when facing heavy damage
    #- barkskin,if=buff.survival_instincts.up&var.health_low&var.barkskin_ready&incoming_damage_3s>player.health*0.5
    
    # Use healing abilities during damage reduction windows
    #- frenzied_regeneration,if=buff.survival_instincts.up&var.health_moderate&var.frenzied_regeneration_ready
    #- renewal,if=var.damage_reduction_active&var.health_low&var.renewal_ready
    
    # === PREVENTIVE DEFENSIVE MEASURES ===
    # Use defensives before taking predictable damage
    #- survival_instincts,if=target.casting&target.cast_time>2&spell_damage_prediction>player.health*0.6&var.survival_instincts_ready
    #- barkskin,if=target.casting&target.cast_time>1.5&spell_damage_prediction>player.health*0.4&var.barkskin_ready&!buff.survival_instincts.up
  
  # Target switching and multi-target DoT maintenance system
  target_switching:
    # === SIMPLE TARGET SWITCHING FOR DOT COVERAGE ===
    # Only switch if we have incomplete DoT coverage and target switching is enabled
    - return,if=var.dot_coverage_complete
    - return,if="!config.target_switching_enabled"
    - return,if=var.single_target_situation
    
    # Switch to next target to check for DoT application opportunities
    - target_enemy,if=nameplates.debuff.rake.count<active_enemies|nameplates.debuff.rip.count<active_enemies
    
    # Apply Rake if current target is missing it and we have energy
    - rake,if="!debuff.rake.up"&var.energy_available_rake
    
    # Apply Rip if current target is missing it and we have combo points
    - rip,if="!debuff.rip.up"&combo_points>=5&var.energy_available_rip
    
    # Refresh Rake if it's in pandemic window
    - rake,if=debuff.rake.refreshable&var.energy_available_rake
    
    # Refresh Rip if it's in pandemic window  
    - rip,if=debuff.rip.refreshable&combo_points>=5&var.energy_available_rip
    - primal_wrath,if=var.aoe_situation&combo_points>=5&var.energy_available_rip&var.rip_spread_targets<=1&dot.rip.refreshable
    
    # Refresh DoTs on multiple targets when resources allow
    - primal_wrath,if=dot.rip.refreshable.8y>=2&combo_points>=5&var.energy_available_primal_wrath&var.aoe_situation
    
    # === TARGET SWITCHING EFFICIENCY VALIDATION ===
    # Return to primary target when DoT coverage is complete
    - return,if=var.dot_coverage_complete&var.maintain_current_target

