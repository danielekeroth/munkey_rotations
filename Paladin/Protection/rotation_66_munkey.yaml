version: 1
author: munkey
spec: 66
name: Protection
description: "An early prototype for Protection Paladin. Mouseover pulling is currently disabled due to missing default binding."
entry: main

morphs:
  judgment: hammer_of_wrath
  divine_toll: hammer_of_light

config:
  allow_pull_with_mo:
    section: "Mouseover"
    label: "Pull with MO"
    type: checkbox
    default: true
  mo_enemy_min_range:
    section: "Mouseover"
    label: "Min. range for MO pull"
    type: slider
    min: 10
    max: 30
    default: 10
  mo_enemy_max_range:
    section: "Mouseover"
    label: "Max. range for MO pull"
    type: slider
    min: 20
    max: 30
    default: 30  
  mo_ooc_res:
    section: "Mouseover"
    label: "MO Res. OOC"
    type: checkbox
    default: true
  ardent_defender_threshold:
    section: "Defensives"
    label: "Ardent Defender HP%"
    default: 90
  divine_shield_threshold:
    section: "Defensives"
    label: "Divine Shield HP%"
    default: 10
  guardian_kings_threshold:
    section: "Defensives"
    label: "Guardian HP%"
    default: 40
  wg_self_threshold:
    label: "Word of Glory"
    type: slider
    min: 10
    max: 100
    default: 20
  auto_loh_self_threshold:
    section: "Defensives"
    label: "Lay on Hands HP%"
    type: slider
    min: 1
    max: 100
    default: 10
  auto_auras:
    section: "Utilities"
    label: "Auto-swap auras"
    type: checkbox
    default: true
  hold_cds_ttd:
    label: "Hold CDs TTD"
    type: slider
    max: 30
    default: 20

variables:
  defensives_available: cooldown.guardian_of_ancient_kings.ready|cooldown.ardent_defender.ready|(cooldown.divine_shield.ready&talent.final_stand)
  immunity_expires_within_1s: buff.divine_shield.remains<1|buff.blessing_of_protection.remains<1
  mo_in_range: mouseover.range>=config.mo_enemy_min_range&mouseover.range<=config.mo_enemy_max_range
  hol_up: buff.hammer_of_light.up
  time_to_full_holy_power: player.gcd*(holy_power.max-holy_power)
  should_build: var.hol_up&var.time_to_full_holy_power<buff.hammer_of_light.up
  valid_mo_target: var.mo_in_range&mouseover.enemy&mouseover.alive&mouseover.attackable
  auto_aura_needs_swap: 
    (mounted&buff.crusader_aura.down)|
    (!mounted&buff.devotion_aura.down)
  # target_interrupt_pct_passed: target.casting.rooted.elapsed>(((target.casting.remains+target.casting.elapsed)*config.interrupt_pct)/100)
  # focus_interrupt_pct_passed: focus.casting.rooted.elapsed>(((focus.casting.remains+focus.casting.elapsed)*config.interrupt_pct)/100)
  # mo_interrupt_pct_passed: mouseover.casting.rooted.elapsed>(((mouseover.casting.remains+mouseover.casting.elapsed)*config.interrupt_pct)/100)
  # should_interrupt_target:
  #   (config.interrupt_target|config.interrupt_all)&target.casting.interruptible&var.target_interrupt_pct_passed
  # should_interrupt_focus:
  #   (config.interrupt_focus|config.interrupt_all)&focus.casting.interruptible&var.focus_interrupt_pct_passed
  # should_interrupt_mo:
  #   (config.interrupt_mouseover|config.interrupt_all)&mouseover.casting.interruptible&var.mo_interrupt_pct_passed
lists:
  opener:
    - consecration,if=target.range=5&!buff.consecration.up&!player.moving
    - blessed_hammer,if=target.range=5&(holy_power<5&(target.debuff.remains(blessed_hammer)<2|cooldown.blessed_hammer.charges=cooldown.blessed_hammer.max_charges))
  cooldowns:
    - hammer_of_light,if=buff.hammer_of_light.up&holy_power=5
    - avenging_wrath
    - divine_toll
  builders:
    - hammer_of_wrath,if=buff.avenging_wrath.up
    - judgment
  mouseover_combat_res:
    - Intercession.mouseover,if=holy_power>=3
    - blessed_hammer,if=target.debuff.remains(blessed_hammer)<2|(cooldown.judgment.remains<player.gcd>?player.gcd.remains|cooldown.hammer_of_wrath.remains<player.gcd>?player.gcd.remains)
    - hammer_of_wrath,if=buff.avenging_wrath.up
    - judgment
  #mouseover_enemy:
  #  - hand_of_reckoning,if=mouseover.enemy&mouseover.targeting_party&mouseover.alive&cooldown.hand_of_reckoning.ready
  #  - avengers_shield,range_check=mouseover,if=cooldown.avengers_shield.ready
  #  - divine_toll,range_check=mouseover,if=cooldown.divine_toll.ready
  interrupts:
    - rebuke,if=interrupts.target.ready
    - rebuke.focus,if=interrupts.interrupts.focus.ready
    - rebuke.mouseover,if=interrupts.mouseover.ready
    - hammer_of_justice,if=interrupts.target.stun.ready
    # - rebuke,if=var.should_interrupt_target
    # - rebuke.focus,if=var.should_interrupt_focus
    # - rebuke.mouseover,if=var.should_interrupt_mo
    # - hammer_of_justice,if=var.should_interrupt_target
  rotation:
    - call_action_list,name=opener,if=!var.should_build
    - call_action_list,name=builders,if=var.should_build
    - hammer_of_light,if=var.hol_up&holy_power=5
    - avengers_shield,if=enemies.combat.8y>1&state.aoe
    - call_action_list,name=cooldowns,if=fight_remains>config.hold_cds_ttd
    - shield_of_the_righteous,if=((buff.bulwark_of_righteous_fury.up&!buff.shield_of_the_righteous.up)|holy_power=5)&!var.should_build
    - call_action_list,name=builders,if=holy_power<5|(holy_power=3&buff.avenging_wrath.up&cooldown.judgment.ready)
    - avengers_shield
    - blessed_hammer
  defensives:
    - guardian_of_ancient_kings,if=health.pct<config.guardian_kings_threshold
    - ardent_defender,if=health.pct<config.ardent_defender_threshold&buff.guardian_of_ancient_kings.down
    - divine_shield,if=health.pct<config.divine_shield_threshold&buff.ardent_defender.down&buff.guardian_of_ancient_kings.down&talent.final_stand
  #shining_light:
    #- word_of_glory,if=action.
  emergency:
    #- call_action_list,name=shining_light,if=buff.shining_light.stack=2
    - word_of_glory,if=health.pct<config.wg_self_threshold&holy_power>3
    - lay_on_hands,if=health.pct<config.auto_loh_self_threshold&var.immunity_expires_within_1s
  aura_management:
    - crusader_aura,range_check=none,if=player.mounted&buff.crusader_aura.down
    - devotion_aura,range_check=none,if=!player.mounted&buff.devotion_aura.down
  main:
    - call_action_list,name=sanity_checks
    - call_action_list,name=spell_queue
    - call_action_list,name=auto_target
    - run_action_list,name=aura_management,if=config.auto_auras&var.auto_aura_needs_swap
    - redemption,if=mouseover.exists&mouseover.friendly&!mouseover.alive&!player.combat
    - return,if=!player.combat
    - return,if=player.mounted
    - call_action_list,name=interrupts
    - cleanse_toxins,cycle=party,if=cycle.dispelable.poison
    - call_action_list,name=defensives
    - run_action_list,name=mouseover_combat_res,if=target.enemy&mouseover.friendly&!mouseover.alive
    - call_action_list,name=emergency
    - call_action_list,name=rotation