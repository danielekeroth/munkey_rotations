version: 1.0
author: munkey
spec: 70
name: Retribution
description: Banging retri rotation

morphs:
    wake_of_ashes: hammer_of_light
    judgment: hammer_of_wrath

config:
  features:
    label: "Features"
    type: multi_select
    options:
      - label: "Smart CDs"
        value: 1
      - label: "Interrupts"
        value: 2
      - label: "Defensives"
        value: 3
    default: [0,1,2]
  ignore_ttd_on_boss:
    label: "Ignore TTD on Boss"
    type: checkbox
    default: true
  ttd_cd_usage:
    label: "TTD CD Useage (s)"
    type: slider
    default: 20
    min: 0
    max: 30
  interrupt_target:
    label: "Interrupt Target"
    type: checkbox
    default: true
  interrupt_mouseover:
    label: "Interrupt Mouseover"
    type: checkbox
    default: true
  aoe_treshold:
    label: "AoE Treshold"
    type: slider
    default: 3
    min: 1
    max: 10
  defensive_toggles:
    label: "Defensive Toggles"
    type: multi_select
    options:
      - label: "Word of Glory"
        value: 1
      - label: "Lay on Hands"
        value: 2
      - label: "Blessing of Protection"
        value: 3
      - label: "Divine Shield"
        value: 4
      - label: "Divine Protection"
        value: 5
    default: [0,1,2,3,4]
  wog_usage:
    label: "Word of Glory HP%"
    type: slider
    default: 30
    min: 0
    max: 100
  loh_usage:
    label: "Lay on Hands HP%"
    type: slider
    default: 30
    min: 0
    max: 100
  bop_usage:
    label: "Blessing of Protection HP%"
    type: slider
    default: 30
    min: 0
    max: 100
  ds_usage:
    label: "Divine Shield HP%"
    type: slider
    default: 30
    min: 0
    max: 100
  dp_usage:
    label: "Divine Protection HP%"
    type: slider
    default: 70
    min: 0
    max: 100

variables:
  # Features
  use_smart_cds: config.features.has(1)
  use_interrupts: config.features.has(2)
  use_defensives: config.features.has(3)

  # State Machine
  is_aoe_combat: active_enemies>=config.aoe_treshold
  is_st_combat: active_enemies<config.aoe_treshold
  opener_complete: combat.time>gcd*7

  # Defensives
  use_wog: config.defensive_toggles.has(1)
  use_loh: config.defensive_toggles.has(2)
  use_bop: config.defensive_toggles.has(3)
  use_ds: config.defensive_toggles.has(4)
  use_dp: config.defensive_toggles.has(5)

  # TTD Logic
  is_ttd_valid: time_to_die<9999&player.combat
  is_fight_remains_valid: fight_remains<9999&player.combat
  is_ttd_or_fm_above_treshold: ((fight_remains>=config.ttd_cd_usage&is_fight_remains_valid)|(time_to_die>config.ttd_cd_usage&is_ttd_valid))
  should_use_cds: (state.cds&!var.use_smart_cds)|(state.cds&var.use_smart_cds&((config.ignore_ttd_on_boss&target.boss)|var.is_ttd_or_fm_above_treshold))

  # Interrupt logic
  should_interrupt: config.interrupt_target&(target.casting.important|target.channeling.important)&!target.interrupt_immune
  should_interrupt_mouse: config.interrupt_mouseover&(mouseover.casting.important|mouseover.channeling.important)&!mouseover.interrupt_immune

  is_templar: talent.lights_guidance
  is_herald: talent.dawnlight
  mo_is_resurrectable: mouseover.friendly&mouseover.dead&mouseover.range<=40

lists:
  emergency_healing:
    - divine_protection,if=var.use_dp&config.dp_usage>0&health.pct<=config.dp_usage&cooldown.divine_protection.ready
    - word_of_glory,if=var.use_wog&config.wog_usage>0&health.pct<=config.wog_usage&cooldown.word_of_glory.ready
    - lay_on_hands,if=var.use_loh&debuff.forbearance.down&config.loh_usage>0&health.pct<=config.loh_usage&cooldown.lay_on_hands.ready
    - blessing_of_protection,if=var.use_bop&debuff.forbearance.down&config.bop_usage>0&health.pct<=config.bop_usage&cooldown.blessing_of_protection.ready
    - divine_shield,if=var.use_ds&debuff.forbearance.down&config.ds_usage>0&health.pct<=config.ds_usage&cooldown.divine_shield.ready
  interrupts:
    - rebuke,if=var.should_interrupt
    - rebuke,if=var.should_interrupt_mouse
  st_opener:
    - hammer_of_wrath,name="Hammer of Wrath (ST Opener - 1)",if=var.is_herald
    - divine_toll,name="Divine Toll (ST Opener - 2)",if=var.is_templar&var.should_use_cds
    - execution_sentence,name="Execution Sentence (ST Opener - 3)",if=var.should_use_cds
    - final_verdict,name="Final Verdict (ST Opener - 4)",if=var.is_herald
    - wake_of_ashes,name="Wake of Ashes (ST Opener - 5)",if=var.should_use_cds
    - hammer_of_light,name="Hammer of Light (ST Opener - 6)",if=var.is_templar&var.should_use_cds
    - divine_toll,name="Divine Toll (ST Opener - 7)",if=var.is_herald&var.should_use_cds
  aoe_opener:
    - hammer_of_wrath,name="Hammer of Wrath (AoE Opener - 1)",if=var.is_herald
    - divine_toll,name="Divine Toll (AoE Opener - 2)",if=var.is_templar&var.should_use_cds
    - execution_sentence,name="Execution Sentence (AoE Opener - 3)",if=var.should_use_cds
    - divine_storm,name="Divine Storm (AoE Opener - 4)",if=var.is_herald&var.should_use_cds
    - wake_of_ashes,name="Wake of Ashes (AoE Opener - 5)",if=var.should_use_cds
    - hammer_of_light,name="Hammer of Light (AoE Opener - 6)",if=var.is_templar&var.should_use_cds
    - divine_toll,name="Divine Toll (AoE Opener - 7)",if=var.is_herald&var.should_use_cds
  st:
    - execution_sentence,name="Execution Sentence (ST - 1)",if=var.should_use_cds
    - hammer_of_light,name="Hammer of Light (ST - 2)",if=var.should_use_cds
    - final_verdict,name="Final Verdict (ST - 3)",if=holy_power>=5
    - wake_of_ashes,name="Wake of Ashes (ST - 4)",if=var.should_use_cds
    - divine_toll,name="Divine Toll (ST - 5)",if=var.should_use_cds
    - blade_of_justice,name="Blade of Justice (ST - 6)",if=!talent.expurgation
    - hammer_of_wrath,name="Hammer of Wrath (ST - 7)"
    - judgment,name="Judgment (ST - 8)",if=cooldown.judgment.charges=2|cooldown.judgment.full_recharge_time<gcd+gcd.remaining
    - final_verdict,name="Final Verdict (ST - 9)",if=holy_power>=4
    - blade_of_justice,name="Blade of Justice (ST - 10)"
    - judgment,name="Judgment (ST - 11)"
    - final_verdict,name="Final Verdict (ST - 12)"
  aoe:
    - execution_sentence,name="Execution Sentence (AoE - 1)",if=var.should_use_cds
    - hammer_of_light,name="Hammer of Light (AoE - 2)",if=var.should_use_cds
    - divine_storm,name="Divine Storm (AoE - 3)",if=holy_power>=5
    - wake_of_ashes,name="Wake of Ashes (AoE - 4)",if=var.should_use_cds
    - divine_toll,name="Divine Toll (AoE - 5)",if=var.should_use_cds
    - blade_of_justice,name="Blade of Justice (AoE - 6)",if=!talent.expurgation
    - hammer_of_wrath,name="Hammer of Wrath (AoE - 7)"
    - judgment,name="Judgment (AoE - 8)",if=cooldown.judgment.charges=2|cooldown.judgment.full_recharge_time<gcd+gcd.remaining
    - divine_storm,name="Divine Storm (AoE - 9)",if=holy_power>=4
    - blade_of_justice,name="Blade of Justice (AoE - 10)"
    - judgment,name="Judgment (AoE - 11)"
    - final_verdict,name="Final Verdict (AoE - 12)",if=buff.empyrean_legacy.up
    - divine_storm,name="Divine Storm (AoE - 13)"
  main:
    - return,if=!state.rotation|state.blocked_inputs|player.mounted|dead
    - call_action_list,name=interrupts,if=var.use_interrupts
    - return,if=!player.combat
    - healthstone,if=health.pct<config.healthstone&healthstone.ready
    - health_potion,if=health.pct<config.healthpotion&health_potion.ready
    - call_action_list,name=emergency_healing,if=var.use_defensives
    - intercession.mouseover,if=var.mo_is_resurrectable
    - return,if=!target.valid|target.range>10
    - avenging_wrath,if=!talent.radiant_glory&var.should_use_cds
    - combat_potion,if=buff.avenging_wrath.up&player.inraid&combat_potion.ready
    - trinket_1,if=trinket_1.ready&var.should_use_cds
    - trinket_2,if=trinket_2.ready&var.should_use_cds
    - call_action_list,name=st_opener,if=var.is_st_combat&!var.opener_complete
    - call_action_list,name=aoe_opener,if=var.is_aoe_combat&!var.opener_complete
    - call_action_list,name=st,if=var.is_st_combat
    - call_action_list,name=aoe,if=var.is_aoe_combat